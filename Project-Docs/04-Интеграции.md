# Спецификации интеграций - Внешние сервисы

## Интеграции


```mermaid
graph TD
    A[Pump.fun Bundler] --> B[Pump.fun Contract]
    A --> C[Jito Block Engine]
    A --> D[Solana RPC Network]
    A --> E[IPFS Storage]
    
    B --> F[Token Creation & Trading]
    C --> G[Bundle Transaction Processing]
    D --> H[Blockchain Interaction]
    E --> I[Metadata Storage]
```

---

## Интеграция с Pump.fun

**Контракт**: `6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P`
**Тип интеграции**: IDL-based Anchor интеграция ==(проверить файл с гита)==

| Аккаунт | Адрес | Назначение |
|---------|-------|------------|
| **Program ID** | `6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P` | Основной контракт |
| **Global** | `4wTV1YmiEkRvAtNtsSGPtUrqRYQMe5SKy2uB4Jjaxnjf` | Глобальные настройки |
| **Fee Recipient** | `CebN5WGQ4jvEPvsVU4EoHEpgzq1VV7AbicfhtW4xC9iM` | Получатель комиссий |
| **Mint Authority** | `TSLvdd1pWpHVjahSpsvCXUbgwsL3JAcvokwaKt1eokM` | Авторизация минтинга |

### ==Инструкции контракта==

```mermaid
sequenceDiagram
    participant CLIENT as Клиент
    participant PUMP as Pump.fun Contract
    participant TOKEN as Token Program
    participant META as Metadata Program
    
    Note over CLIENT,META: Создание токена
    CLIENT->>PUMP: create(name, symbol, uri)
    PUMP->>TOKEN: Создание mint аккаунта
    PUMP->>META: Создание metadata
    PUMP->>PUMP: Инициализация bonding curve
    
    Note over CLIENT,META: Покупка токенов
    CLIENT->>PUMP: buy(amount, max_sol_cost)
    PUMP->>PUMP: Расчет по bonding curve
    PUMP->>TOKEN: Mint токенов покупателю
    PUMP->>PUMP: Обновление ликвидности
```
### Лимиты и ограничения

- **Минимальная покупка**: 0.000001 SOL (~100 lamports)
- **Максимальная покупка**: Ограничена ликвидностью bonding curve
- **Слипа**: Автоматический расчет в контракте


---

## Интеграция с Jito Block Engine

### Спецификация

**Эндпоинт**: `mainnet.block-engine.jito.wtf:443`
**Протокол**: gRPC (TLS)
**Аутентификация**: Ed25519 keypair 

### gRPC 

```mermaid
graph LR
    A[Jito Client] --> B[SearcherService]
    B --> C[SendBundle]
    B --> D[GetTipAccounts]
    B --> E[SubscribeBundleResults]
    
    C --> F[Bundle Response]
    D --> G[Tip Accounts List]
    E --> H[Bundle Status Stream]
```

### Структура Bundle запроса

```protobuf
message SendBundleRequest {
  Bundle bundle = 1;
}

message Bundle {
  Header header = 1;
  repeated bytes transactions = 2;
}

message Header {
  uint64 tip = 1;
}
```

### Bundle ограничения

- **Максимум транзакций**: 5 в одном bundle
- **Максимальный размер**: 1232 байта на транзакцию
- **Минимальный tip**: 100,000 lamports (0.0001 SOL)
- **Таймаут**: 30 секунд на обработку

### Мониторинг статуса Bundle

```mermaid
stateDiagram-v2
    [*] --> Отправлен : SendBundle()
    Отправлен --> Принят : Bundle accepted
    Отправлен --> Отклонен : Invalid bundle
    
    Принят --> Обрабатывается : In mempool
    Обрабатывается --> Включен_в_блок : Block confirmation
    Обрабатывается --> Истек_таймаут : 30s timeout
    
    Включен_в_блок --> [*] : Success
    Отклонен --> [*] : Failure
    Истек_таймаут --> [*] : Timeout
```

---

## Интеграция с Solana RPC

### Провайдеры RPC

**Основные провайдеры**:
1. **Helius** - `https://mainnet.helius-rpc.com/?api-key={API_KEY}`
2. **QuickNode** - `https://solana-mainnet.quiknode.pro/{API_KEY}/`
3. **Alchemy** - `https://solana-mainnet.g.alchemy.com/v2/{API_KEY}`

**Запас**:
- `https://api.mainnet-beta.solana.com`
- `https://solana-api.projectserum.com`

### RPC методы

```mermaid
graph TD
    A[RPC Methods] --> B[getRecentBlockhash]
    A --> C[getAccountInfo]
    A --> D[sendTransaction]
    A --> E[getSignatureStatus]
    A --> F[getTokenAccountsByOwner]
    
    B --> G[Построение транзакций]
    C --> H[Проверка балансов]
    D --> I[Отправка транзакций]
    E --> J[Мониторинг статуса]
    F --> K[Управление токенами]
```

### Rate Limiting

| Провайдер | Requests/sec | Burst Limit | WebSocket |
|-----------|--------------|-------------|-----------|
| **Helius** | 100 | 1000 | Да |
| **QuickNode** | 50 | 500 | Да |
| **Alchemy** | 30 | 300 | Да |
| **Public** | 10 | 40 | Нет |

### Retry стратегия

```mermaid
flowchart TD
    A[RPC Request] --> B{Response OK?}
    B -->|200| C[Success]
    B -->|429| D[Rate Limited]
    B -->|5xx| E[Server Error]
    B -->|Timeout| F[Network Error]
    
    D --> G[Wait + Exponential Backoff]
    E --> H[Switch RPC Provider]
    F --> I[Retry Same Provider]
    
    G --> J{Max Retries?}
    H --> J
    I --> J
    
    J -->|No| A
    J -->|Yes| K[Fail Request]
```

---

## Интеграция с IPFS

### Провайдер: Pinata

**API Base URL**: `https://api.pinata.cloud`
**Аут: JWT в Authorization
Gateway**: `https://gateway.pinata.cloud/ipfs/{hash}`

### Ручки для загрузки

```mermaid
sequenceDiagram
    participant CLIENT as Клиент
    participant PINATA as Pinata API
    participant IPFS as IPFS Network
    
    Note over CLIENT,IPFS: Загрузка изображения
    CLIENT->>PINATA: POST /pinning/pinFileToIPFS
    PINATA->>IPFS: Pin файл в сети
    IPFS-->>PINATA: IPFS Hash
    PINATA-->>CLIENT: {"IpfsHash": "Qm..."}
    
    Note over CLIENT,IPFS: Загрузка метаданных
    CLIENT->>PINATA: POST /pinning/pinJSONToIPFS
    PINATA->>IPFS: Pin JSON в сети
    IPFS-->>PINATA: IPFS Hash
    PINATA-->>CLIENT: {"IpfsHash": "Qm..."}
```

### Структура метаданных токена

```json
{
  "name": "Token Name",
  "symbol": "SYMBOL", 
  "description": "Token description",
  "image": "https://gateway.pinata.cloud/ipfs/{image_hash}",
  "external_url": "https://example.com",
  "attributes": [],
  "properties": {
    "files": [
      {
        "uri": "https://gateway.pinata.cloud/ipfs/{image_hash}",
        "type": "image/png"
      }
    ],
    "category": "image"
  }
}
```

### Лимиты Pinata

- **Размер файла**: До 100MB
- **Requests/месяц**: 1000 (free)
- **Bandwidth**: 1GB/месяц (free
- **Pin лимит**: 1000 файлов (free)

---

## Обработка ошибок интеграций

### Классификация ошибок

```mermaid
graph TD
    A[Integration Error] --> B{Service Type}
    B -->|Pump.fun| C[Contract Error]
    B -->|Jito| D[Bundle Error]  
    B -->|RPC| E[Network Error]
    B -->|IPFS| F[Storage Error]
    
    C --> G[Invalid Instruction]
    C --> H[Insufficient Funds]
    C --> I[Slippage Exceeded]
    
    D --> J[Bundle Rejected]
    D --> K[Tip Too Low]
    D --> L[Transaction Too Large]
    
    E --> M[Rate Limited]
    E --> N[RPC Unavailable] 
    E --> O[Invalid Response]
    
    F --> P[Upload Failed]
    F --> Q[File Too Large]
    F --> R[Network Timeout]
```

### Стратегии восстановления

| Тип ошибки | Действие | Retry | Timeout |
|------------|----------|-------|---------|
| **Rate Limit** | Exponential backoff | 3x | 60s |
| **Network** | Switch provider | 2x | 30s |
| **Validation** | Fix and retry | 1x | - |
| **Funds** | Stop execution | 0x | - |
