
## Основные процессы системы

### 1. Алгоритм создания токена с bundle покупками

Это главный процесс системы, который объединяет создание токена и массовые покупки в одном блоке.

```mermaid
sequenceDiagram
    participant USER as ОНО
    participant CLI as CLI
    participant CONFIG as Конфигурация
    participant WALLET as Кошельки
    participant META as Метаданные
    participant LUT as Lookup Tables
    participant PUMP as Pump.fun
    participant JITO as Jito Bundle
    participant SOLANA as Solana RPC
    
    Note over USER,SOLANA: Фаза подготовки
    USER->>CLI: Команда создания токена
    CLI->>CONFIG: Загрузка настроек
    CLI->>WALLET: Проверка балансов
    CLI->>META: Загрузка изображения в IPFS
    META-->>CLI: URI метаданных
    
    Note over USER,SOLANA: Фаза построения bundle
    CLI->>LUT: Получение LUT адреса
    CLI->>PUMP: Создание инструкции токена
    CLI->>PUMP: Создание покупательских инструкций
    CLI->>JITO: Формирование bundle транзакций
    
    Note over USER,SOLANA: Фаза исполнения
    JITO->>JITO: Добавление tip транзакций
    JITO->>SOLANA: Отправка bundle в Block Engine
    SOLANA-->>JITO: Подтверждение блока
    JITO-->>CLI: Статус выполнения
    CLI-->>USER: Результат операции
```




### 2. Алгоритм распределения покупок

Стратегическое распределение покупательской нагрузки между кошельками.

```mermaid
graph TD
    A[Общий бюджет SOL] --> B[Определение количества покупателей]
    B --> C[Расчет базовой суммы на кошелек]
    C --> D[Применение случайного разброса ±20%]
    D --> E[Проверка минимальных лимитов]
    E --> F{Соответствует лимитам Pump.fun?}
    F -->|Нет| G[Корректировка объемов]
    F -->|Да| H[Финальное распределение]
    G --> F
    H --> I[Создание планов покупок]
```

**Формула расчета**:
$$
\text{Сумма на кошелек} = \frac{\text{Общий бюджет}}{n} \times (1 + \text{random}(-0.2, 0.2))
$$

Где:
- $n$ = количество покупательских кошельков (5-16)
- $\text{random}(-0.2, 0.2)$ = случайное отклонение ±20%

### 4. Процесс валидации перед запуском

Комплексная проверка готовности системы к запуску bundle.

```mermaid
flowchart TD
    A[Старт валидации] --> B[Проверка конфигурации]
    B --> C[Проверка RPC подключения]
    C --> D[Валидация Jito авторизации]
    D --> E[Проверка балансов кошельков]
    E --> F[Валидация метаданных токена]
    F --> G[Проверка LUT статуса]
    G --> H[Тестирование Pump.fun подключения]
    
    B --> B1{Конфигурация корректна?}
    C --> C1{RPC доступен?}
    D --> D1{Jito авторизован?}
    E --> E1{Достаточно SOL?}
    F --> F1{Метаданные валидны?}
    G --> G1{LUT активна?}
    H --> H1{Pump.fun доступен?}
    
    B1 -->|Нет| ERROR[Ошибка валидации]
    C1 -->|Нет| ERROR
    D1 -->|Нет| ERROR
    E1 -->|Нет| ERROR
    F1 -->|Нет| ERROR
    G1 -->|Нет| ERROR
    H1 -->|Нет| ERROR
    
    B1 -->|Да| I[Все проверки пройдены]
    C1 -->|Да| I
    D1 -->|Да| I
    E1 -->|Да| I
    F1 -->|Да| I
    G1 -->|Да| I
    H1 -->|Да| I
    
    I --> SUCCESS[Готов к запуску]
```

### 5. Алгоритм обработки ошибок bundle

Система восстановления после сбоев.

```mermaid
stateDiagram-v2
    [*] --> Отправка_Bundle
    Отправка_Bundle --> Ожидание_Результата
    
    Ожидание_Результата --> Успех : Bundle подтвержден
    Ожидание_Результата --> Анализ_Ошибки : Bundle отклонен
    
    Анализ_Ошибки --> Retry_Сеть : Сетевая ошибка
    Анализ_Ошибки --> Retry_RPC : RPC недоступен
    Анализ_Ошибки --> Фатальная_Ошибка : Ошибка валидации
    
    Retry_Сеть --> Подождать : Backoff delay
    Retry_RPC --> Сменить_RPC : Переключение провайдера
    
    Подождать --> Отправка_Bundle : Повторная попытка
    Сменить_RPC --> Отправка_Bundle : Новый RPC
    
    Фатальная_Ошибка --> [*] : Завершение с ошибкой
    Успех --> [*] : Завершение успешно
```

**Параметры retry логики**:
- Максимум попыток: 3
- Backoff delay: 2^n с
- Таймаут ожидания: 3000 

---

### Bundle Construction Algorithm


```mermaid
graph TD
    A[Список всех операций] --> B[Группировка по типам]
    B --> C[Создание токена + Dev покупка]
    B --> D[Buy 1-3]
    B --> E[Buy 4-7]
    B --> F[Buy 8-11]
    B --> G[Buy 12-16]
    
    C --> H[Транза 1 + Tip]
    D --> I[Транза 2 + Tip]
    E --> J[Транза 3 + Tip]
    F --> K[Транза 4 + Tip]
    G --> L[Транза 5 + Tip]
    
    H --> M[Bundle из 5 транз]
    I --> M
    J --> M
    K --> M
    L --> M
```

- Base Fee = стандартная комиссия сети (~5000 lamports)
- Priority Fee = дополнительная плата за приоритет (~10000 lamports)
- Jito Tip = чаевые для Block Engine (~100000 lamports)

---

## Криты

### 1. Timing Dependencies
- **LUT активация**: Требует подтверждения в блокчейне перед использованием
- **Metadata доступность**: IPFS должен успеть распространить файлы
- **Bundle координация**: Все транзакции должны быть готовы одновременно

### 2. Resource Management
- **SOL распределение**: Точный расчет необходимых балансов
- **RPC лимиты**: Контроль количества запросов к провайдеру
- **Memory usage**: Оптимизация работы с большими данными

### 3. Error Recovery Points
- **Pre-validation**: Проверка всех условий перед стартом
- **Mid-process checkpoints**: Возможность восстановления с промежуточной точки
- **Post-execution cleanup**: Освобождение ресурсов после завершения

